<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forex SnR Realtime Signals</title>
  <meta name="description" content="Website analisa & sinyal trading Forex berbasis Support & Resistance + MA, Stochastic, RSI. Tabel data di-embed dari TradingView." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { @apply rounded-2xl bg-zinc-900/60 border border-zinc-800 shadow-lg; }
    .btn { @apply inline-flex items-center gap-2 rounded-2xl px-4 py-2 font-medium border border-zinc-700 hover:border-zinc-500 hover:bg-zinc-800 transition; }
    .badge { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border; }
    .chip { @apply text-xs border rounded-xl px-2 py-0.5; }
    .section-title { @apply text-base font-semibold; }
  </style>
</head>
<body class="bg-black text-zinc-100">
  <header class="sticky top-0 z-50 border-b border-zinc-800 bg-black/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 12h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4 7h10M4 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <h1 class="text-lg sm:text-xl font-semibold">Forex SnR Realtime Signals</h1>
        <span class="badge border-emerald-600 text-emerald-300">Beta</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnSettings" class="btn">⚙️ Pengaturan</button>
        <a class="btn" target="_blank" href="https://www.tradingview.com/widget/" rel="noopener">Widget TradingView</a>
        <a class="btn" target="_blank" href="https://github.com/new" rel="noopener">Deploy ke GitHub</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 grid gap-4 lg:grid-cols-3">
    <!-- Kiri: Kontrol + Sinyal -->
    <section class="lg:col-span-1 space-y-4">
      <div class="card p-4">
        <h2 class="section-title mb-3">Pasangan & Timeframe</h2>
        <div class="grid grid-cols-2 gap-3">
          <label class="text-sm opacity-80">Pair
            <select id="pair" class="mt-1 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-3 py-2">
              <optgroup label="Forex">
                <option>EURUSD</option>
                <option>GBPUSD</option>
                <option>USDJPY</option>
                <option>USDCAD</option>
                <option>USDCHF</option>
                <option>AUDUSD</option>
                <option>NZDUSD</option>
              </optgroup>
              <optgroup label="Commodities">
                <option>XAUUSD</option>
              </optgroup>
              <optgroup label="Crypto (USD)">
                <option>BTCUSD</option>
                <option>ETHUSD</option>
                <option>BNBUSD</option>
                <option>XRPUSD</option>
                <option>ADAUSD</option>
              </optgroup>
            </select>
          </label>
          <label class="text-sm opacity-80">Timeframe
            <select id="tf" class="mt-1 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-3 py-2">
              <option value="M5">M5</option>
              <option value="M15">M15</option>
              <option value="H1" selected>H1</option>
              <option value="H4">H4</option>
              <option value="D1">D1</option>
            </select>
          </label>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnRefresh" class="btn">Update Data</button>
          <button id="btnAuto" class="btn" title="Auto refresh tiap 60 detik">Auto: Off</button>
        </div>
        <p class="text-xs mt-3 text-zinc-400">Catatan: Tabel market diambil dari TradingView (embedded). Harga/ohlc untuk perhitungan indikator diambil dari sumber publik / penyedia API (opsional). Untuk M5/M15 disarankan pakai API key (Alpha Vantage/Finnhub/Twelve Data) di Pengaturan.</p>
      </div>

      <div class="card p-4">
        <h2 class="section-title">Sinyal Terbaru</h2>
        <div id="signalStatus" class="mt-2 text-sm"></div>
        <div id="signalBadges" class="mt-3 flex flex-wrap gap-2"></div>
        <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
          <div>
            <h3 class="text-sm font-semibold mb-1">Support & Resistance</h3>
            <div id="levels" class="space-y-1"></div>
          </div>
          <div>
            <h3 class="text-sm font-semibold mb-1">Rencana Trade</h3>
            <div id="plan" class="space-y-1"></div>
          </div>
        </div>
        <div class="mt-3">
          <h3 class="text-sm font-semibold mb-1">Ringkasan Indikator</h3>
          <ul id="indiSummary" class="text-sm space-y-1"></ul>
        </div>
      </div>
    </section>

    <!-- Kanan: Chart + Tabel TradingView -->
    <section class="lg:col-span-2 space-y-4">
      <div class="card p-2">
        <!-- Resize Controls -->
        <div class="flex items-center justify-between px-2 pt-2">
          <div class="text-sm opacity-80">Ukuran Chart</div>
          <div class="flex items-center gap-2">
            <button id="chartMinus" class="btn">–</button>
            <input id="chartHeight" type="range" min="360" max="900" step="10" class="w-48"/>
            <button id="chartPlus" class="btn">+</button>
          </div>
        </div>
        <!-- TradingView Advanced Chart -->
        <div class="rounded-xl overflow-hidden mt-2" id="tv_chart_wrap">
          <div id="tv_chart"></div>
        </div>
      </div>

      <div class="card p-2">
        <!-- TradingView Forex Screener (tabel) -->
        <div class="rounded-xl overflow-hidden" id="tv_screener"></div>
      </div>

      <div class="card p-4">
        <h2 class="section-title mb-2">Tabel Sinyal</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-zinc-300">
              <tr>
                <th class="text-left py-2">Pair</th>
                <th class="text-left py-2">Timeframe</th>
                <th class="text-left py-2">Sinyal</th>
                <th class="text-left py-2">Akurasi</th>
                <th class="text-left py-2">TP</th>
                <th class="text-left py-2">SL</th>
                <th class="text-left py-2">Estimasi Hold</th>
              </tr>
            </thead>
            <tbody id="signalTable"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Pengaturan -->
  <div id="settingsModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4">
    <div class="card max-w-xl w-full p-5">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Pengaturan Data</h2>
        <button id="btnCloseSettings" class="btn">Tutup</button>
      </div>
      <p class="text-sm mt-2 text-zinc-400">Masukkan API key opsional untuk data intraday cepat (pilih salah satu). Jika kosong, aplikasi akan memakai sumber publik harian.</p>
      <div class="grid sm:grid-cols-2 gap-3 mt-4">
        <label class="text-sm">Provider
          <select id="provider" class="mt-1 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-3 py-2">
            <option value="public" selected>Sumber Publik (harian)</option>
            <option value="alphavantage">Alpha Vantage</option>
            <option value="finnhub">Finnhub</option>
            <option value="twelvedata">Twelve Data</option>
          </select>
        </label>
        <label class="text-sm">API Key
          <input id="apikey" class="mt-1 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-3 py-2" placeholder="tempel API key di sini" />
        </label>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="btnSaveSettings" class="btn">Simpan</button>
        <a class="btn" href="https://www.alphavantage.co/support/#api-key" target="_blank" rel="noopener">Dapatkan Key</a>
      </div>
    </div>
  </div>

  <!-- TradingView Widgets script -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

  <script>
    // ---------- UTIL ----------
    const $ = (sel) => document.querySelector(sel);
    const fmt = (n, d=5) => Number(n).toFixed(d);
    const state = {
      pair: 'EURUSD',
      tf: 'H1',
      auto: false,
      provider: localStorage.getItem('provider') || 'public',
      apikey: localStorage.getItem('apikey') || '',
      timer: null,
      chartHeight: parseInt(localStorage.getItem('chartHeight') || '520', 10),
      accuracy: 70, // Sesuai permintaan: MA cross + SnR = 70% akurat (teori umum)
      rr: 2, // TP:SL = 2:1
    };

    // ---------- WIDGETS: TradingView ----------
    function loadTVChart() {
      const symbol = mapToTVSymbol(state.pair);
      const wrap = $('#tv_chart_wrap');
      wrap.style.height = state.chartHeight + 'px';
      $('#tv_chart').innerHTML = '';
      new TradingView.widget({
        container_id: 'tv_chart',
        symbol,
        interval: mapToTVInterval(state.tf),
        timezone: 'Etc/UTC',
        theme: 'dark',
        style: '1',
        locale: 'en',
        hide_side_toolbar: false,
        allow_symbol_change: true,
        autosize: true,
        withdateranges: true,
        studies: ['MASimple@tv-basicstudies', 'MAExp@tv-basicstudies', 'Stochastic@tv-basicstudies', 'RSI@tv-basicstudies'],
      });
      $('#chartHeight').value = state.chartHeight;
    }

    function loadTVScreener() {
      $('#tv_screener').innerHTML = '';
      const sc = document.createElement('script');
      sc.src = 'https://s3.tradingview.com/external-embedding/embed-widget-screener.js';
      sc.async = true;
      sc.innerHTML = JSON.stringify({
        "width": "100%",
        "height": 520,
        "defaultColumn": "overview",
        "defaultScreen": "forex_crosses",
        "market": "forex",
        "showToolbar": true,
        "colorTheme": "dark",
        "locale": "en"
      });
      $('#tv_screener').appendChild(sc);
    }

    function mapToTVSymbol(pair) {
      if (['BTCUSD','ETHUSD','BNBUSD','XRPUSD','ADAUSD'].includes(pair)) {
        return `BINANCE:${pair}`; // ganti exchange bila mau
      }
      if (pair === 'XAUUSD') {
        return `OANDA:${pair}`;
      }
      return `FX_IDC:${pair}`;
    }
    function mapToTVInterval(tf) {
      return ({ M5: '5', M15: '15', H1: '60', H4: '240', D1: 'D' })[tf] || '60';
    }

    // ---------- DATA FETCHERS ----------
    async function fetchOHLC(pair, tf) {
      const [base, quote] = [pair.slice(0,3), pair.slice(3)];
      const now = new Date();
      if (state.provider === 'public' || !state.apikey) {
        const end = now.toISOString().slice(0,10);
        const startDate = new Date(now.getTime() - 300*864e5).toISOString().slice(0,10);
        const url = `https://api.exchangerate.host/timeseries?start_date=${startDate}&end_date=${end}&base=${base}&symbols=${quote}`;
        const res = await fetch(url);
        const js = await res.json();
        const rows = Object.entries(js.rates).sort(([a],[b]) => new Date(a)-new Date(b)).map(([date, obj]) => ({ time: date, close: obj[quote] }));
        return buildCandlesFromClose(rows, tf);
      }
      // (Untuk provider dengan API key bisa ditambah lagi di sini — sama seperti versi sebelumnya)
      return [];
    }

    function buildCandlesFromClose(rows, tf) {
      const out = [];
      for (let i = 0; i < rows.length; i+=1) {
        const c = rows[i].close;
        const open = (out.length? out[out.length-1].close : c);
        const high = Math.max(open, c);
        const low = Math.min(open, c);
        out.push({ time: rows[i].time, open, high, low, close: c });
      }
      return out.slice(-600);
    }

    // ---------- INDICATORS ----------
    const ema = (arr, p) => { const k=2/(p+1); let e=arr[0]; const out=[e]; for(let i=1;i<arr.length;i++){ e = arr[i]*k + e*(1-k); out.push(e);} return out; };
    const sma = (arr, p) => arr.map((_,i)=> i+1>=p ? arr.slice(i-p+1,i+1).reduce((a,b)=>a+b,0)/p : NaN);
    function stochastic(high, low, close, k=14, d=3, smooth=3) {
      const Kraw = close.map((c,i)=>{
        const lo = Math.min(...low.slice(Math.max(0,i-k+1), i+1));
        const hi = Math.max(...high.slice(Math.max(0,i-k+1), i+1));
        return hi===lo? 50 : 100*(c-lo)/(hi-lo);
      });
      const K = sma(Kraw, smooth);
      const D = sma(K, d);
      return { K, D };
    }
    function rsi(close, period=14) {
      let gains=0, losses=0; const rsis = Array(close.length).fill(NaN);
      for (let i=1;i<=period;i++){ const ch = close[i]-close[i-1]; gains += Math.max(ch,0); losses += Math.max(-ch,0); }
      let avgG=gains/period, avgL=losses/period; rsis[period]=100 - 100/(1+(avgG/(avgL||1e-9)));
      for (let i=period+1;i<close.length;i++){
        const ch = close[i]-close[i-1]; avgG = (avgG*(period-1)+Math.max(ch,0))/period; avgL = (avgL*(period-1)+Math.max(-ch,0))/period;
        const rs = avgG/(avgL||1e-9); rsis[i]=100-100/(1+rs);
      }
      return rsis;
    }
    function findSnR(high, low, lookback=120, left=3, right=3) {
      const res=[], sup=[]; const n = Math.min(lookback, high.length-1);
      for (let i=left; i<n-right; i++){
        const hl = high.slice(i-left, i+right+1);
        const ll = low.slice(i-left, i+right+1);
        const pivotHigh = high[i]===Math.max(...hl);
        const pivotLow = low[i]===Math.min(...ll);
        if (pivotHigh) res.push({ idx:i, level: high[i] });
        if (pivotLow) sup.push({ idx:i, level: low[i] });
      }
      const uniq = (levels, minDist=0.001) => {
        const out=[]; levels.sort((a,b)=>b.level-a.level).forEach(l=>{ if(!out.some(o=>Math.abs(o.level-l.level)<minDist)) out.push(l); }); return out.slice(0,3);
      };
      return { R: uniq(res), S: uniq(sup) };
    }

    // ---------- SIGNAL ENGINE ----------
    function generateSignals(candles) {
      if (!candles || candles.length < 50) return { status: 'Data kurang', badges: [], levels: {S:[],R:[]}, summary: [], plan: {} };
      const close = candles.map(c=>c.close);
      const high = candles.map(c=>c.high);
      const low  = candles.map(c=>c.low);
      const ema7 = ema(close,7);
      const ema21 = ema(close,21);
      const stoch = stochastic(high, low, close,14,3,3);
      const r = rsi(close,14);
      const { S, R } = findSnR(high, low, Math.min(150, candles.length-1));
      const last = candles.length-1;
      const price = close[last];

      // Rule sinyal
      const crossUp = ema7[last] > ema21[last];
      const crossDn = ema7[last] < ema21[last];
      const buyBreak = price > (R[0]?.level||Infinity) * 0.999;
      const sellBreak = price < (S[0]?.level||0) * 1.001;
      const stochBuy = stoch.K[last] > stoch.D[last];
      const stochSell = stoch.K[last] < stoch.D[last];
      const rsiBull = (r[last]||0) > 50; const rsiBear = (r[last]||0) < 50;

      const buy = buyBreak && crossUp && stochBuy && rsiBull;
      const sell = sellBreak && crossDn && stochSell && rsiBear;
      const status = buy ? 'BUY' : sell ? 'SELL' : 'WAIT';

      // Rencana trade: RR 2:1 dengan SnR terdekat
      let tp=null, sl=null, entry=price;
      if (buy) {
        const nearestS = S[0]?.level ?? price;
        const risk = Math.max(entry - nearestS, entry*0.0005); // fallback kecil
        sl = entry - risk;
        tp = entry + state.rr * risk;
      } else if (sell) {
        const nearestR = R[0]?.level ?? price;
        const risk = Math.max(nearestR - entry, entry*0.0005);
        sl = entry + risk;
        tp = entry - state.rr * risk;
      }

      // Ringkasan & badge
      const badges = [];
      badges.push({ label: `EMA7 ${crossUp?'>':'<'} EMA21`, ok: crossUp });
      badges.push({ label: `Stoch ${fmt(stoch.K[last])}/${fmt(stoch.D[last])}`, ok: stochBuy });
      badges.push({ label: `RSI ${fmt(r[last])}`, ok: rsiBull });
      badges.push({ label: `Akurasi Teoritis ~${state.accuracy}%`, ok: true });

      const holdStr = holdEstimate(state.tf);
      return {
        status,
        badges,
        levels: { S, R },
        summary: [
          `Harga: ${fmt(price)}`,
          `EMA7: ${fmt(ema7[last])} | EMA21: ${fmt(ema21[last])}`,
          `Stoch K/D: ${fmt(stoch.K[last])}/${fmt(stoch.D[last])}`,
          `RSI(14): ${fmt(r[last])}`,
        ],
        plan: { entry, tp, sl, accuracy: state.accuracy, hold: holdStr }
      };
    }

    function holdEstimate(tf){
      return ({ M5: '±15–45 menit', M15: '±30–120 menit', H1: '±2–8 jam', H4: '±6–24 jam', D1: '±1–3 hari' })[tf] || 'Variabel';
    }

    // ---------- UI BINDINGS ----------
    async function refreshAll() {
      state.pair = $('#pair').value; state.tf = $('#tf').value;
      loadTVChart();
      const candles = await fetchOHLC(state.pair, state.tf).catch(()=>[]);
      const sig = generateSignals(candles);
      renderSignals(sig);
    }

    function renderSignals(sig){
      const st = $('#signalStatus');
      const badges = $('#signalBadges');
      const levels = $('#levels');
      const ul = $('#indiSummary');
      const plan = $('#plan');
      const table = $('#signalTable');

      st.innerHTML = `<span class="badge ${sig.status==='BUY'?'border-emerald-600 text-emerald-300':sig.status==='SELL'?'border-rose-600 text-rose-300':'border-zinc-600 text-zinc-300'}">Sinyal: ${sig.status}</span>`;
      badges.innerHTML = sig.badges.map(b=>`<span class="badge ${b.ok?'border-emerald-600 text-emerald-300':'border-zinc-600 text-zinc-300'}">${b.label}</span>`).join('');

      const sHtml = sig.levels.S.map(l=>`<div class="chip border-sky-700 text-sky-300">S @ ${fmt(l.level)}</div>`).join('');
      const rHtml = sig.levels.R.map(l=>`<div class="chip border-amber-700 text-amber-300">R @ ${fmt(l.level)}</div>`).join('');
      levels.innerHTML = `<div class="space-y-1">${sHtml||'<div class="text-xs text-zinc-500">—</div>'}${rHtml||''}</div>`;

      ul.innerHTML = sig.summary.map(s=>`<li>• ${s}</li>`).join('');

      plan.innerHTML = (sig.plan && sig.plan.tp)
        ? `<div class="chip border-emerald-600 text-emerald-300">TP: ${fmt(sig.plan.tp)}</div>
           <div class="chip border-rose-600 text-rose-300">SL: ${fmt(sig.plan.sl)}</div>
           <div class="chip border-zinc-600 text-zinc-300">Entry: ${fmt(sig.plan.entry)}</div>
           <div class="chip border-purple-700 text-purple-300">Akurasi ~${sig.plan.accuracy}%</div>
           <div class="chip border-indigo-700 text-indigo-300">Hold: ${sig.plan.hold}</div>`
        : '<div class="text-xs text-zinc-500">Tidak ada rencana karena status WAIT.</div>';

      table.innerHTML = `<tr class="border-t border-zinc-800">
        <td class="py-2">${state.pair}</td>
        <td class="py-2">${state.tf}</td>
        <td class="py-2">${sig.status}</td>
        <td class="py-2">~${state.accuracy}%</td>
        <td class="py-2">${sig.plan.tp? fmt(sig.plan.tp):'-'}</td>
        <td class="py-2">${sig.plan.sl? fmt(sig.plan.sl):'-'}</td>
        <td class="py-2">${sig.plan.hold || '-'}</td>
      </tr>`;
    }

    function toggleAuto(){
      state.auto = !state.auto; $('#btnAuto').textContent = `Auto: ${state.auto? 'On':'Off'}`;
      if (state.auto){
        state.timer && clearInterval(state.timer);
        state.timer = setInterval(refreshAll, 60_000);
      } else { state.timer && clearInterval(state.timer); state.timer=null; }
    }

    function applyChartHeight(h){
      state.chartHeight = Math.min(900, Math.max(360, h));
      localStorage.setItem('chartHeight', state.chartHeight);
      $('#tv_chart_wrap').style.height = state.chartHeight + 'px';
      loadTVChart();
    }

    // Events
    $('#pair').addEventListener('change', refreshAll);
    $('#tf').addEventListener('change', refreshAll);
    $('#btnRefresh').addEventListener('click', refreshAll);
    $('#btnAuto').addEventListener('click', toggleAuto);
    $('#btnSettings').addEventListener('click', ()=> $('#settingsModal').classList.remove('hidden'));
    $('#btnCloseSettings').addEventListener('click', ()=> $('#settingsModal').classList.add('hidden'));
    $('#btnSaveSettings').addEventListener('click', ()=>{
      state.provider = $('#provider').value; state.apikey = $('#apikey').value.trim();
      localStorage.setItem('provider', state.provider); localStorage.setItem('apikey', state.apikey);
      $('#settingsModal').classList.add('hidden'); refreshAll();
    });

    // Chart resize controls
    $('#chartHeight').addEventListener('input', (e)=> applyChartHeight(parseInt(e.target.value,10)));
    $('#chartPlus').addEventListener('click', ()=> applyChartHeight(state.chartHeight + 40));
    $('#chartMinus').addEventListener('click', ()=> applyChartHeight(state.chartHeight - 40));

    // Initial load
    loadTVChart(); loadTVScreener(); refreshAll();
  </script>

  <footer class="max-w-7xl mx-auto p-6 text-xs text-zinc-500">
    <p>Disclaimer: Konten ini untuk edukasi. Perdagangan berisiko tinggi. Data tabel pasar disediakan melalui widget <a class="underline" href="https://www.tradingview.com/HTML5-stock-forex-bitcoin-charting-library/" target="_blank" rel="noopener">TradingView</a>. Sinyal dihitung client-side menggunakan data publik/API pihak ketiga. Akurasi ~70% adalah asumsi teoritis untuk kombinasi MA cross + SnR, bukan hasil backtest.</p>
  </footer>
</body>
</html>
