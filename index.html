<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forex SnR + Indicator Realtime Signals</title>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <style>
    body { background:#0b0b0b; color:white; font-family:Arial, sans-serif; }
    #chart { width:100%; height:80vh; }
    .controls { margin:10px; }
    button { margin:5px; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
    .small { height:300px !important; }
    .medium { height:500px !important; }
    .large { height:700px !important; }
    .fullscreen { height:95vh !important; }
    table { border-collapse: collapse; width: 70%; margin-top: 10px; }
    table, th, td { border: 1px solid #444; }
    th, td { padding: 8px; text-align: center; }
    .bullish { background: #1a4; color:white; font-weight:bold; }
    .bearish { background: #c22; color:white; font-weight:bold; }
    .neutral { background: #cc0; color:black; font-weight:bold; }
  </style>
</head>
<body>

  <h2>📊 Forex SnR + Indicator Realtime Signals</h2>

  <div class="controls">
    Pair: 
    <select id="pair">
      <option value="EURUSD">EURUSD</option>
      <option value="GBPUSD">GBPUSD</option>
      <option value="USDJPY">USDJPY</option>
      <option value="XAUUSD">XAUUSD (Gold)</option>
      <option value="BTCUSD">BTCUSD (Bitcoin)</option>
      <option value="ETHUSD">ETHUSD (Ethereum)</option>
    </select>

    Timeframe:
    <select id="timeframe">
      <option value="1min">1m</option>
      <option value="5min">5m</option>
      <option value="15min">15m</option>
      <option value="60min">1h</option>
      <option value="daily">1D</option>
    </select>
  </div>

  <div id="chart"></div>

  <div class="controls">
    <button onclick="resizeChart('small')">Kecil</button>
    <button onclick="resizeChart('medium')">Sedang</button>
    <button onclick="resizeChart('large')">Besar</button>
    <button onclick="resizeChart('fullscreen')">Fullscreen</button>
  </div>

  <h3>📈 Sinyal Terbaru</h3>
  <div id="signal">Loading...</div>

  <script>
    const apiKey = "IOP9EDHO1ARXGFMN"; // Alpha Vantage API Key
    let widget;

    // Mapping pair ke TradingView symbol
    function getTradingViewSymbol(pair) {
      switch(pair) {
        case "EURUSD": return "FX:EURUSD";
        case "GBPUSD": return "FX:GBPUSD";
        case "USDJPY": return "FX:USDJPY";
        case "XAUUSD": return "OANDA:XAUUSD";
        case "BTCUSD": return "BINANCE:BTCUSDT";
        case "ETHUSD": return "BINANCE:ETHUSDT";
        default: return "FX:EURUSD";
      }
    }

    // Load chart TradingView
    function loadChart() {
      const pair = document.getElementById("pair").value;
      const timeframe = document.getElementById("timeframe").value;
      const symbol = getTradingViewSymbol(pair);

      document.getElementById("chart").innerHTML = "";
      widget = new TradingView.widget({
        container_id: "chart",
        autosize: true,
        symbol: symbol,
        interval: timeframe,
        theme: "dark",
        style: "1",
        locale: "en",
        toolbar_bg: "#0b0b0b",
        enable_publishing: false,
        hide_top_toolbar: false,
        hide_legend: false
      });

      fetchSignal(pair, timeframe);
    }

    // SMA
    function SMA(data, period) {
      let sma = [];
      for (let i = 0; i <= data.length - period; i++) {
        let sum = 0;
        for (let j = 0; j < period; j++) {
          sum += parseFloat(data[i + j]);
        }
        sma.push(sum / period);
      }
      return sma;
    }

    // RSI
    function RSI(closes, period = 14) {
      let gains = [], losses = [];
      for (let i = 1; i < closes.length; i++) {
        let diff = closes[i] - closes[i-1];
        if (diff >= 0) gains.push(diff);
        else losses.push(Math.abs(diff));
      }
      let avgGain = gains.reduce((a,b) => a+b, 0) / period;
      let avgLoss = losses.reduce((a,b) => a+b, 0) / period;
      let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    // EMA
    function EMA(data, period) {
      let k = 2 / (period + 1);
      let emaArray = [];
      emaArray[0] = data[0];
      for (let i = 1; i < data.length; i++) {
        emaArray[i] = data[i] * k + emaArray[i - 1] * (1 - k);
      }
      return emaArray;
    }

    // MACD
    function MACD(closes) {
      let ema12 = EMA(closes, 12);
      let ema26 = EMA(closes, 26);
      let macdLine = ema12.map((val, i) => val - ema26[i]);
      let signalLine = EMA(macdLine.slice(ema26.length - ema12.length), 9);
      return { macdLine, signalLine };
    }

    // Fetch signal
    async function fetchSignal(pair, timeframe) {
      let url = "";
      let from = pair.substring(0,3);
      let to = pair.substring(3,6);

      if(pair === "BTCUSD" || pair === "ETHUSD") {
        url = `https://www.alphavantage.co/query?function=DIGITAL_CURRENCY_INTRADAY&symbol=${from}&market=USD&apikey=${apiKey}`;
      } else if(pair === "XAUUSD") {
        url = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=XAU&to_currency=USD&apikey=${apiKey}`;
      } else {
        url = `https://www.alphavantage.co/query?function=FX_INTRADAY&from_symbol=${from}&to_symbol=${to}&interval=${timeframe}&apikey=${apiKey}`;
      }

      try {
        let res = await fetch(url);
        let data = await res.json();
        let hargaSekarang = null, open = null, high = null, low = null, signal = "";
        let rsi = null, macdData = null;
        let maStatus = "-", rsiStatus = "-", macdStatus = "-", finalClass = "neutral";

        if(data["Time Series FX ("+timeframe+")"]) {
          let series = data["Time Series FX ("+timeframe+")"];
          let closes = [];
          for (let t in series) {
            closes.push(parseFloat(series[t]["4. close"]));
          }

          closes = closes.reverse();
          let sma20 = SMA(closes, 20);
          let sma50 = SMA(closes, 50);
          rsi = RSI(closes);
          macdData = MACD(closes);

          hargaSekarang = closes[closes.length-1];
          open = parseFloat(series[Object.keys(series)[0]]["1. open"]);
          high = parseFloat(series[Object.keys(series)[0]]["2. high"]);
          low = parseFloat(series[Object.keys(series)[0]]["3. low"]);

          let lastMACD = macdData.macdLine[macdData.macdLine.length-1];
          let lastSignal = macdData.signalLine[macdData.signalLine.length-1];

          // Evaluasi
          maStatus = sma20[sma20.length-1] > sma50[sma50.length-1] ? "Bullish" : "Bearish";
          rsiStatus = rsi < 30 ? "Oversold (Bullish)" : (rsi > 70 ? "Overbought (Bearish)" : "Normal");
          macdStatus = lastMACD > lastSignal ? "Bullish" : "Bearish";

          if (maStatus==="Bullish" && rsi<70 && lastMACD>lastSignal) {
            signal = "BUY 📈";
            finalClass = "bullish";
          } else if (maStatus==="Bearish" && rsi>30 && lastMACD<lastSignal) {
            signal = "SELL 📉";
            finalClass = "bearish";
          } else {
            signal = "WAIT ⏳";
            finalClass = "neutral";
          }
        }

        if(hargaSekarang) {
          document.getElementById("signal").innerHTML = `
            <b>Pair:</b> ${pair} | Harga: ${hargaSekarang}<br><br>
            <table>
              <tr><th>Indikator</th><th>Status</th></tr>
              <tr><td>MA Cross</td><td class="${maStatus==="Bullish"?"bullish":"bearish"}">${maStatus}</td></tr>
              <tr><td>RSI</td><td class="${rsi<30?"bullish":(rsi>70?"bearish":"neutral")}">${rsiStatus} (${Math.round(rsi)})</td></tr>
              <tr><td>MACD</td><td class="${macdStatus==="Bullish"?"bullish":"bearish"}">${macdStatus}</td></tr>
              <tr><td><b>Final Signal</b></td><td class="${finalClass}"><b>${signal}</b></td></tr>
            </table>
            <br>🎯 Akurasi Teori: ~85-90% (MA + RSI + MACD + SnR)<br>
            📌 Rekomendasi TP/SL: 2:1 Ratio<br>
          `;
        } else {
          document.getElementById("signal").innerText = "Gagal ambil data.";
        }

      } catch (err) {
        document.getElementById("signal").innerText = "Error ambil sinyal.";
      }
    }

    // Resize Chart
    function resizeChart(size) {
      let chart = document.getElementById("chart");
      chart.className = size;
      localStorage.setItem("chartSize", size);
    }

    // Simpan preferensi ukuran chart
    window.onload = () => {
      let size = localStorage.getItem("chartSize") || "medium";
      resizeChart(size);
      loadChart();
    };

    document.getElementById("pair").addEventListener("change", loadChart);
    document.getElementById("timeframe").addEventListener("change", loadChart);
  </script>

</body>
</html>
