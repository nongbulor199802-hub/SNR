<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SnR Signal Pro - Multi Pair</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { 
      background:#0f172a; 
      color:#f8fafc; 
      font-family:'Segoe UI', Tahoma, sans-serif; 
      margin:0; 
      padding:0;
    }
    header {
      background:#1e293b; 
      padding:20px; 
      text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,0.5);
    }
    h1 {
      margin:0;
      color:#38bdf8;
      font-size:28px;
      letter-spacing:1px;
    }
    main { padding:20px; max-width:1200px; margin:auto; }
    .controls {
      margin-bottom:20px; 
      display:flex; 
      gap:10px; 
      align-items:center;
    }
    select {
      padding:10px 14px; 
      border-radius:10px; 
      border:none; 
      font-size:16px;
      background:#334155; 
      color:#f8fafc;
    }
    .card {
      background:#1e293b; 
      padding:20px; 
      border-radius:14px; 
      margin-top:20px;
      box-shadow:0 4px 10px rgba(0,0,0,0.6);
    }
    h2 { margin-top:0; }
    .buy { color:#22c55e; font-weight:bold; }
    .sell { color:#ef4444; font-weight:bold; }
    .neutral { color:#eab308; font-weight:bold; }
    iframe {
      width:100%; 
      height:500px; 
      border:none; 
      border-radius:14px; 
      margin-top:20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä SnR Signal Pro</h1>
  </header>
  <main>
    <div class="controls">
      <label for="pair">Pilih Pair:</label>
      <select id="pair" onchange="loadData()">
        <option value="xauusd">XAUUSD (Gold)</option>
        <option value="eurusd">EURUSD</option>
        <option value="gbpusd">GBPUSD</option>
        <option value="usdjpy">USDJPY</option>
        <option value="btcusd">BTCUSD</option>
        <option value="ethusd">ETHUSD</option>
      </select>
    </div>

    <div id="signal" class="card">Loading...</div>
    <div id="chart"></div>
  </main>

  <script>
    async function loadData() {
      let pair = document.getElementById("pair").value;
      const url = `https://stooq.com/q/d/l/?s=${pair}&c=1&d=1`;

      try {
        const resp = await fetch(url);
        const csv = await resp.text();
        const data = Papa.parse(csv, {header:true}).data
          .filter(d => d.Date && d.Close)
          .map(d => ({
            date: d.Date,
            close: parseFloat(d.Close),
            high: parseFloat(d.High),
            low: parseFloat(d.Low)
          }));

        if(data.length < 30) {
          document.getElementById("signal").innerHTML = "‚ö†Ô∏è Data tidak cukup untuk analisa.";
          return;
        }

        // === indikator ===
        function EMA(period, values) {
          let k = 2/(period+1);
          let emaArray = [];
          let ema = values.slice(0, period).reduce((a,b)=>a+b,0)/period;
          emaArray[period-1] = ema;
          for (let i=period; i<values.length; i++) {
            ema = values[i]*k + ema*(1-k);
            emaArray[i] = ema;
          }
          return emaArray;
        }
        function RSI(period, values) {
          let rsi = [];
          for (let i=period; i<values.length; i++) {
            let gains=0, losses=0;
            for (let j=i-period+1;j<=i;j++){
              let diff = values[j]-values[j-1];
              if(diff>=0) gains+=diff; else losses-=diff;
            }
            let rs = gains/period / (losses/period || 1);
            rsi[i] = 100 - (100/(1+rs));
          }
          return rsi;
        }
        function MACD(values) {
          let ema12 = EMA(12, values);
          let ema26 = EMA(26, values);
          let macd = values.map((v,i)=> (ema12[i]||0) - (ema26[i]||0));
          let signal = EMA(9, macd);
          return {macd, signal};
        }
        function ATR(period, data) {
          let atr = [];
          for (let i=period; i<data.length; i++) {
            let trs = [];
            for (let j=i-period+1; j<=i; j++) {
              let high = data[j].high, low = data[j].low, prevClose = data[j-1].close;
              let tr = Math.max(
                high-low,
                Math.abs(high-prevClose),
                Math.abs(low-prevClose)
              );
              trs.push(tr);
            }
            atr[i] = trs.reduce((a,b)=>a+b,0)/period;
          }
          return atr;
        }

        const closes = data.map(d=>d.close);
        const ema7 = EMA(7, closes);
        const ema21 = EMA(21, closes);
        const rsi14 = RSI(14, closes);
        const {macd} = MACD(closes);
        const atr14 = ATR(14, data);

        function getSignal(i) {
          if (ema7[i] > ema21[i] && rsi14[i] > 50 && macd[i] > 0) return "BUY";
          if (ema7[i] < ema21[i] && rsi14[i] < 50 && macd[i] < 0) return "SELL";
          return "NEUTRAL";
        }

        let i = closes.length-1;
        let price = closes[i];
        let lastSignal = getSignal(i);
        let atr = atr14[i] || 0;

        let TP = null, SL = null;
        if (lastSignal === "BUY") {
          TP = price + 2*atr;
          SL = price - 1*atr;
        } else if (lastSignal === "SELL") {
          TP = price - 2*atr;
          SL = price + 1*atr;
        }

        let wins = 0, total = 0;
        for (let j = closes.length-55; j < closes.length-3; j++) {
          let sig = getSignal(j);
          if(sig==="BUY" || sig==="SELL") {
            total++;
            if(sig==="BUY" && closes[j+3] > closes[j]) wins++;
            if(sig==="SELL" && closes[j+3] < closes[j]) wins++;
          }
        }
        let accuracy = total>0 ? (wins/total*100).toFixed(1) : "0";

        document.getElementById("signal").innerHTML = `
          <h2>${pair.toUpperCase()} ‚Üí <span class="${lastSignal.toLowerCase()}">${lastSignal}</span></h2>
          <p>üìà Harga terakhir: <b>${price.toFixed(2)}</b></p>
          <p>‚úÖ Akurasi Backtest (50 candle): <b>${accuracy}%</b></p>
          <p>üìä Total sinyal diuji: ${total}, Win: ${wins}</p>
          ${TP && SL ? `
            <p>üéØ Target Profit: <b>${TP.toFixed(2)}</b></p>
            <p>üõë Stop Loss: <b>${SL.toFixed(2)}</b></p>
            <p>‚öñÔ∏è Rasio Risk/Reward: 1:2</p>
          ` : ""}
        `;

        // === TradingView Chart Embed ===
        const tvSymbol = pair.toUpperCase()+"USD";
        document.getElementById("chart").innerHTML = `
          <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_${pair}&symbol=${tvSymbol}&interval=15&hidesidetoolbar=1&symboledit=1&saveimage=1&toolbarbg=rgba(0,0,0,1)&studies=[]&theme=dark&style=1&timezone=Etc/UTC"
          allowfullscreen></iframe>
        `;
      } catch (e) {
        document.getElementById("signal").innerHTML = "‚ùå Gagal mengambil data.";
      }
    }

    loadData();
  </script>
</body>
</html>
