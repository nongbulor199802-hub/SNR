<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>SnR Signal</title>
  <style>
    body { background: #111; color: white; font-family: Arial, sans-serif; }
    .card { background: #1a1a1a; padding: 15px; border-radius: 10px; margin: 10px 0; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; border-radius: 6px; }
    #chart { width: 100%; height: 400px; margin-top: 20px; }
  </style>
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <h2>üìä Sinyal SnR + MA</h2>

  <label>Pair:
    <select id="pair">
      <option value="XAU/USD">XAUUSD (Gold)</option>
      <option value="EUR/USD">EURUSD</option>
      <option value="GBP/USD">GBPUSD</option>
      <option value="USD/JPY">USDJPY</option>
    </select>
  </label>

  <label>Timeframe:
    <select id="timeframe">
      <option value="5min">M5</option>
      <option value="15min">M15</option>
      <option value="30min">M30</option>
      <option value="1h">H1</option>
      <option value="4h">H4</option>
      <option value="1day">D1</option>
    </select>
  </label>

  <button onclick="getSignal()">Ambil/Refresh</button>

  <div class="card">
    <h3>üìà Sinyal Terbaru</h3>
    <p id="signal">Menunggu...</p>
    <p id="snr"></p>
  </div>

  <div id="chart"></div>

  <script>
    const API_KEY = "40192b2b-9b48-4695-b721-102a0074a722"; // TwelveData API Key
    let chart, candleSeries, supportLine, resistanceLine;

    async function fetchData(symbol, interval) {
      const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${interval}&outputsize=100&apikey=${API_KEY}`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.values) {
          return data.values.reverse(); // urut lama -> baru
        } else {
          throw new Error(data.message || "Data kosong");
        }
      } catch (err) {
        console.error("Error fetch:", err);
        return null;
      }
    }

    function calculateMA(data, period) {
      let ma = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          ma.push(null);
        } else {
          let sum = 0;
          for (let j = 0; j < period; j++) {
            sum += parseFloat(data[i - j].close);
          }
          ma.push(sum / period);
        }
      }
      return ma;
    }

    function findSnR(data) {
      const highs = data.map(d => parseFloat(d.high));
      const lows = data.map(d => parseFloat(d.low));
      const closes = data.map(d => parseFloat(d.close));

      let resistance = Math.max(...highs.slice(-20));
      let support = Math.min(...lows.slice(-20));
      let lastClose = closes[closes.length - 1];

      return { support, resistance, lastClose };
    }

    function renderChart(data, support, resistance) {
      if (!chart) {
        chart = LightweightCharts.createChart(document.getElementById("chart"), {
          layout: { background: { color: "#111" }, textColor: "white" },
          grid: { vertLines: { color: "#333" }, horzLines: { color: "#333" } },
          width: document.getElementById("chart").clientWidth,
          height: 400
        });
        candleSeries = chart.addCandlestickSeries({
          upColor: "#0f0", downColor: "#f00", borderUpColor: "#0f0", borderDownColor: "#f00", wickUpColor: "#0f0", wickDownColor: "#f00"
        });
      }

      const candleData = data.map(d => ({
        time: new Date(d.datetime).getTime() / 1000,
        open: parseFloat(d.open),
        high: parseFloat(d.high),
        low: parseFloat(d.low),
        close: parseFloat(d.close)
      }));

      candleSeries.setData(candleData);

      // hapus garis lama kalau ada
      if (supportLine) chart.removeSeries(supportLine);
      if (resistanceLine) chart.removeSeries(resistanceLine);

      // tambahkan garis support & resistance
      supportLine = chart.addLineSeries({ color: "cyan", lineWidth: 2 });
      resistanceLine = chart.addLineSeries({ color: "yellow", lineWidth: 2 });

      const times = candleData.map(c => c.time);
      supportLine.setData(times.map(t => ({ time: t, value: support })));
      resistanceLine.setData(times.map(t => ({ time: t, value: resistance })));
    }

    async function getSignal() {
      const pair = document.getElementById("pair").value;
      const tf = document.getElementById("timeframe").value;

      document.getElementById("signal").innerText = "Mengambil data...";
      document.getElementById("snr").innerText = "";

      const data = await fetchData(pair, tf);

      if (!data) {
        document.getElementById("signal").innerText = `‚ùå Gagal ambil data ${pair}`;
        return;
      }

      // Hitung MA
      const ma20 = calculateMA(data, 20);
      const ma50 = calculateMA(data, 50);

      // Ambil SnR
      const { support, resistance, lastClose } = findSnR(data);

      // Tentukan sinyal
      let signal = "‚ö†Ô∏è Tidak ada sinyal";
      if (ma20[ma20.length - 2] < ma50[ma50.length - 2] && ma20[ma20.length - 1] > ma50[ma50.length - 1] && lastClose > support) {
        signal = "‚úÖ BUY Signal (MA Cross + dekat Support)";
      } else if (ma20[ma20.length - 2] > ma50[ma50.length - 2] && ma20[ma20.length - 1] < ma50[ma50.length - 1] && lastClose < resistance) {
        signal = "‚ùå SELL Signal (MA Cross + dekat Resistance)";
      }

      document.getElementById("signal").innerText = signal;
      document.getElementById("snr").innerText = `Support: ${support} | Resistance: ${resistance} | Close: ${lastClose}`;

      // Render chart candlestick + garis SnR
      renderChart(data, support, resistance);
    }
  </script>
</body>
</html>
